# Location: `/manifests/jobs/db-backup-cronjob.yaml`

apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgresql-backup
  namespace: kubeestatehub
  labels:
    app: postgresql-backup
    app.kubernetes.io/name: postgresql-backup
    app.kubernetes.io/component: backup
    app.kubernetes.io/part-of: kubeestatehub
spec:
  schedule: "0 1 * * *" # Daily at 1 AM
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 5
  failedJobsHistoryLimit: 3
  startingDeadlineSeconds: 600
  suspend: false
  jobTemplate:
    metadata:
      labels:
        app: postgresql-backup
        job-type: database-backup
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 3600 # 1 hour timeout
      template:
        metadata:
          labels:
            app: postgresql-backup
            job-type: database-backup
        spec:
          serviceAccountName: postgresql-backup-sa
          securityContext:
            runAsNonRoot: true
            runAsUser: 999
            runAsGroup: 999
            fsGroup: 999
            seccompProfile:
              type: RuntimeDefault
          containers:
            - name: pg-backup
              image: postgres:15.4-alpine
              imagePullPolicy: Always
              command:
                - /bin/sh
                - -c
                - |
                  set -e

                  # Create backup directory
                  mkdir -p /backup

                  # Generate timestamp
                  TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                  BACKUP_FILE="/backup/kubeestatehub_backup_${TIMESTAMP}.sql"

                  echo "Starting backup at $(date)"

                  # Create database backup
                  PGPASSWORD=$POSTGRES_PASSWORD pg_dump \
                    -h $POSTGRES_HOST \
                    -U $POSTGRES_USER \
                    -d $POSTGRES_DB \
                    --verbose \
                    --no-password \
                    --format=custom \
                    --blobs \
                    --no-privileges \
                    --no-owner \
                    --file="${BACKUP_FILE}"

                  # Compress backup
                  gzip "${BACKUP_FILE}"
                  BACKUP_FILE="${BACKUP_FILE}.gz"

                  echo "Backup completed: ${BACKUP_FILE}"
                  echo "Backup size: $(du -h ${BACKUP_FILE} | cut -f1)"

                  # Upload to S3 if configured
                  if [ -n "$AWS_S3_BUCKET" ]; then
                    echo "Uploading backup to S3..."
                    # Install aws cli if needed
                    apk add --no-cache aws-cli
                    aws s3 cp "${BACKUP_FILE}" "s3://$AWS_S3_BUCKET/backups/postgresql/"
                    echo "Upload completed"
                  fi

                  # Clean up old local backups (keep only 3 days)
                  find /backup -name "kubeestatehub_backup_*.sql.gz" -mtime +3 -delete

                  echo "Backup job completed successfully at $(date)"
              env:
                - name: POSTGRES_HOST
                  value: "postgresql-db"
                - name: POSTGRES_PORT
                  value: "5432"
                - name: POSTGRES_DB
                  valueFrom:
                    configMapKeyRef:
                      name: db-configmap
                      key: database-name
                - name: POSTGRES_USER
                  valueFrom:
                    secretKeyRef:
                      name: db-secret
                      key: username
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: db-secret
                      key: password
                - name: AWS_S3_BUCKET
                  valueFrom:
                    configMapKeyRef:
                      name: backup-config
                      key: s3-bucket
                      optional: true
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: global-env-secret
                      key: AWS_ACCESS_KEY_ID
                      optional: true
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: global-env-secret
                      key: AWS_SECRET_ACCESS_KEY
                      optional: true
                - name: AWS_DEFAULT_REGION
                  valueFrom:
                    secretKeyRef:
                      name: global-env-secret
                      key: AWS_REGION
                      optional: true
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                  ephemeral-storage: 2Gi
                limits:
                  cpu: 500m
                  memory: 512Mi
                  ephemeral-storage: 5Gi
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                runAsNonRoot: true
                runAsUser: 999
                runAsGroup: 999
                capabilities:
                  drop:
                    - ALL
              volumeMounts:
                - name: backup-storage
                  mountPath: /backup
                - name: tmp
                  mountPath: /tmp
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: backup-pvc
            - name: tmp
              emptyDir: {}
          restartPolicy: Never
          nodeSelector:
            kubernetes.io/os: linux
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: postgresql-backup-sa
  namespace: kubeestatehub
  labels:
    app: postgresql-backup
    app.kubernetes.io/name: postgresql-backup-sa
    app.kubernetes.io/component: backup
    app.kubernetes.io/part-of: kubeestatehub
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backup-pvc
  namespace: kubeestatehub
  labels:
    app: postgresql-backup
    app.kubernetes.io/name: backup-pvc
    app.kubernetes.io/component: backup
    app.kubernetes.io/part-of: kubeestatehub
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  storageClassName: standard-hdd
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-config
  namespace: kubeestatehub
  labels:
    app: postgresql-backup
    app.kubernetes.io/name: backup-config
    app.kubernetes.io/component: backup
    app.kubernetes.io/part-of: kubeestatehub
data:
  s3-bucket: "kubeestatehub-backups"
  retention-days: "30"
  backup-schedule: "0 1 * * *"
  compress: "true"
