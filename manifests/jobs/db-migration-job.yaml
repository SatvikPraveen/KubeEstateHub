# Location: `/manifests/jobs/db-migration-job.yaml`

apiVersion: batch/v1
kind: Job
metadata:
  name: db-migration
  namespace: kubeestatehub
  labels:
    app: db-migration
    app.kubernetes.io/name: db-migration
    app.kubernetes.io/component: migration
    app.kubernetes.io/part-of: kubeestatehub
    migration-version: "v1.0.0"
spec:
  backoffLimit: 3
  activeDeadlineSeconds: 1800 # 30 minutes timeout
  template:
    metadata:
      labels:
        app: db-migration
        job-type: database-migration
    spec:
      serviceAccountName: db-migration-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
        seccompProfile:
          type: RuntimeDefault
      initContainers:
        - name: wait-for-db
          image: postgres:15.4-alpine
          imagePullPolicy: Always
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Waiting for PostgreSQL to be ready..."
              until PGPASSWORD=$POSTGRES_PASSWORD psql -h $POSTGRES_HOST -U $POSTGRES_USER -d $POSTGRES_DB -c "SELECT 1" > /dev/null 2>&1; do
                echo "PostgreSQL is not ready yet. Waiting..."
                sleep 5
              done
              echo "PostgreSQL is ready!"
          env:
            - name: POSTGRES_HOST
              value: "postgresql-db"
            - name: POSTGRES_DB
              valueFrom:
                configMapKeyRef:
                  name: db-configmap
                  key: database-name
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: db-secret
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-secret
                  key: password
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 999
            runAsGroup: 999
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      containers:
        - name: migrate
          image: ghcr.io/kubeestatehub/db-migrator:latest
          imagePullPolicy: Always
          command:
            - /bin/sh
            - -c
            - |
              set -e

              echo "Starting database migration at $(date)"

              # Create migrations table if it doesn't exist
              PGPASSWORD=$POSTGRES_PASSWORD psql -h $POSTGRES_HOST -U $POSTGRES_USER -d $POSTGRES_DB -c "
                CREATE TABLE IF NOT EXISTS schema_migrations (
                  version VARCHAR(255) PRIMARY KEY,
                  applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                  description TEXT,
                  checksum VARCHAR(64)
                );
              "

              echo "Running migrations..."

              # Apply migrations
              python3 /app/migrate.py --config /etc/migration/config.yaml --apply

              echo "Migration completed successfully at $(date)"
          env:
            - name: POSTGRES_HOST
              value: "postgresql-db"
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_DB
              valueFrom:
                configMapKeyRef:
                  name: db-configmap
                  key: database-name
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: db-secret
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-secret
                  key: password
            - name: MIGRATION_MODE
              value: "apply"
            - name: DRY_RUN
              value: "false"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
              ephemeral-storage: 1Gi
            limits:
              cpu: 500m
              memory: 256Mi
              ephemeral-storage: 2Gi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 999
            runAsGroup: 999
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: migration-config
              mountPath: /etc/migration
              readOnly: true
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: migration-config
          configMap:
            name: db-migration-config
        - name: tmp
          emptyDir: {}
      restartPolicy: Never
      nodeSelector:
        kubernetes.io/os: linux
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: db-migration-sa
  namespace: kubeestatehub
  labels:
    app: db-migration
    app.kubernetes.io/name: db-migration-sa
    app.kubernetes.io/component: migration
    app.kubernetes.io/part-of: kubeestatehub
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: db-migration-config
  namespace: kubeestatehub
  labels:
    app: db-migration
    app.kubernetes.io/name: db-migration-config
    app.kubernetes.io/component: migration
    app.kubernetes.io/part-of: kubeestatehub
data:
  config.yaml: |
    database:
      host: postgresql-db
      port: 5432
      name: kubeestatehub
      ssl_mode: prefer
      
    migrations:
      directory: /app/migrations
      table: schema_migrations
      lock_timeout: 300
      
    logging:
      level: info
      format: json
      
    validation:
      check_schema: true
      verify_checksums: true

  001_initial_schema.sql: |
    -- Initial schema for KubeEstateHub

    -- Create listings table
    CREATE TABLE IF NOT EXISTS listings (
      id SERIAL PRIMARY KEY,
      mls_number VARCHAR(50) UNIQUE NOT NULL,
      title VARCHAR(255) NOT NULL,
      description TEXT,
      property_type VARCHAR(50) NOT NULL,
      price DECIMAL(12,2) NOT NULL,
      bedrooms INTEGER,
      bathrooms DECIMAL(3,1),
      square_feet INTEGER,
      lot_size DECIMAL(10,2),
      address VARCHAR(255) NOT NULL,
      city VARCHAR(100) NOT NULL,
      state VARCHAR(50) NOT NULL,
      zip_code VARCHAR(20) NOT NULL,
      latitude DECIMAL(10,8),
      longitude DECIMAL(11,8),
      listing_date DATE NOT NULL,
      status VARCHAR(20) DEFAULT 'active',
      agent_name VARCHAR(100),
      agent_email VARCHAR(100),
      agent_phone VARCHAR(20),
      image_url VARCHAR(500),
      thumbnail_url VARCHAR(500),
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Create indexes
    CREATE INDEX IF NOT EXISTS idx_listings_mls_number ON listings(mls_number);
    CREATE INDEX IF NOT EXISTS idx_listings_price ON listings(price);
    CREATE INDEX IF NOT EXISTS idx_listings_property_type ON listings(property_type);
    CREATE INDEX IF NOT EXISTS idx_listings_city ON listings(city);
    CREATE INDEX IF NOT EXISTS idx_listings_status ON listings(status);
    CREATE INDEX IF NOT EXISTS idx_listings_listing_date ON listings(listing_date);
    CREATE INDEX IF NOT EXISTS idx_listings_location ON listings(latitude, longitude);

  002_market_trends.sql: |
    -- Market trends and analytics tables

    CREATE TABLE IF NOT EXISTS market_trends (
      id SERIAL PRIMARY KEY,
      city VARCHAR(100) NOT NULL,
      state VARCHAR(50) NOT NULL,
      zip_code VARCHAR(20),
      property_type VARCHAR(50) NOT NULL,
      period_start DATE NOT NULL,
      period_end DATE NOT NULL,
      avg_price DECIMAL(12,2),
      median_price DECIMAL(12,2),
      total_listings INTEGER,
      total_sales INTEGER,
      days_on_market_avg DECIMAL(5,1),
      price_per_sqft_avg DECIMAL(8,2),
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      UNIQUE(city, state, property_type, period_start, period_end)
    );

    CREATE INDEX IF NOT EXISTS idx_market_trends_location ON market_trends(city, state);
    CREATE INDEX IF NOT EXISTS idx_market_trends_period ON market_trends(period_start, period_end);
    CREATE INDEX IF NOT EXISTS idx_market_trends_property_type ON market_trends(property_type);

  003_user_management.sql: |
    -- User management and authentication

    CREATE TABLE IF NOT EXISTS users (
      id SERIAL PRIMARY KEY,
      email VARCHAR(255) UNIQUE NOT NULL,
      username VARCHAR(100) UNIQUE NOT NULL,
      password_hash VARCHAR(255) NOT NULL,
      first_name VARCHAR(100),
      last_name VARCHAR(100),
      phone VARCHAR(20),
      role VARCHAR(50) DEFAULT 'user',
      is_active BOOLEAN DEFAULT true,
      email_verified BOOLEAN DEFAULT false,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
    CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
    CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);

    CREATE TABLE IF NOT EXISTS user_sessions (
      id SERIAL PRIMARY KEY,
      user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
      session_token VARCHAR(255) UNIQUE NOT NULL,
      expires_at TIMESTAMP NOT NULL,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE INDEX IF NOT EXISTS idx_user_sessions_token ON user_sessions(session_token);
    CREATE INDEX IF NOT EXISTS idx_user_sessions_user_id ON user_sessions(user_id);
    CREATE INDEX IF NOT EXISTS idx_user_sessions_expires_at ON user_sessions(expires_at);
